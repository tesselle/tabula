---
output: github_document
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
library(tabula)
```

# tabula <img width=120px src="man/figures/logo.svg" align="right" />

[![Build Status](https://travis-ci.org/nfrerebeau/tabula.svg?branch=master)](https://travis-ci.org/nfrerebeau/tabula)
[![GitHub Release](https://img.shields.io/github/release/nfrerebeau/tabula.svg)](https://github.com/nfrerebeau/tabula/releases)
[![CRAN Version](http://www.r-pkg.org/badges/version/tabula)](https://cran.r-project.org/package=tabula)
[![CRAN Downloads](http://cranlogs.r-pkg.org/badges/grand-total/tabula)](https://cran.r-project.org/package=tabula)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.1489944.svg)](https://doi.org/10.5281/zenodo.1489944)

## Overview

`tabula` provides an easy way to examine archaeological count data (artifacts, faunal remains, etc.). This package includes several measures of diversity (e.g. richness, rarefaction, diversity, turnover, similarity, etc.) discussed in Magurran (1988) and others. It also provides matrix seriation methods for chronological modeling and dating. The package make it easy to visualize count data and statistical thresholds: rank/abundance plots, Ford (1972) and Bertin (1977) diagrams, etc.

## Installation

Install the released version of `tabula` from CRAN:

```{r cran-installation, eval = FALSE}
install.packages("tabula")
```

Or install the development version from GitHub with:

```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("nfrerebeau/tabula")
```

## Usage

`tabula` provides a set of S4 classes that extend the `matrix` data type from R `base`. These new classes represent different special types of matrix.

* Abundance matrix:
    * `CountMatrix` represents count data,
    * `FrequencyMatrix` represents frequency data.
* Logical matrix:
    * `IncidenceMatrix` represents presence/absence data.
    * `OccurrenceMatrix` represents a co-occurence matrix.

It assumes that you keep your data tidy: each variable (type/taxa) must be saved in its own column and each observation (sample/case) must be saved in its own row.

These new classes are of simple use, on the same way as the base `matrix`:

```{r create, eval=FALSE}
# Define a count data matrix
quanti <- CountMatrix(data = sample(0:10, 100, TRUE),
                      nrow = 10, ncol = 10)

# Define a logical matrix
# Data will be coerced with as.logical()
quali <- IncidenceMatrix(data = sample(0:1, 100, TRUE),
                         nrow = 10, ncol = 10)
```

`tabula` uses coercing mechanisms (with validation methods) for data type conversions:

```{r coerce}
# Create a count matrix
A1 <- CountMatrix(data = sample(0:10, 100, TRUE),
                  nrow = 10, ncol = 10)

# Coerce counts to frequencies
B <- as(A1, "FrequencyMatrix")

# Row sums are internally stored before coercing to a frequency matrix
# (use totals() to get these values)
# This allows to restore the source data
A2 <- as(B, "CountMatrix")
all(A1 == A2)

# Coerce to presence/absence
C <- as(A1, "IncidenceMatrix")

# Coerce to a co-occurrence matrix
D <- as(A1, "OccurrenceMatrix")
```

### Analysis

```{r import}
count <- as(compiegne, "CountMatrix")
```

#### Sample richness

```{r richness}
richness(count, method = c("margalef", "menhinick"), simplify = TRUE)
```

#### Heterogeneity and evenness measures

*Diversity* can be measured according to several indices (sometimes refered to as indices of *heterogeneity*):

```{r diversity}
diversity(count, method = c("shannon", "brillouin", "simpson", "mcintosh", "berger"), simplify = TRUE)
```

Note that `berger`, `mcintosh` and `simpson` methods return a *dominance* index, not the reciprocal form usually adopted, so that an increase in the value of the index accompanies a decrease in diversity.

*Evenness* is a measure of how evenly individuals are distributed across the sample:
```{r evenness}
evenness(count, method = c("shannon", "brillouin", "simpson", "mcintosh"), simplify = TRUE)
```

#### Turnover

The following method can be used to acertain the degree of *turnover* in taxa composition along a gradient ($\beta$-diversity) on qualitative (presence/absence) data.

It assumes that the order of the matrix rows (from $1$ to $n$) follows the progression along the gradient/transect.

```{r turnover}
turnover(count, method = c("whittaker", "cody", "routledge1",
                           "routledge2", "routledge3", "wilson"),
         simplify = TRUE)
```

#### Similarity coefficients

$\beta$-diversity can also be measured by addressing *similarity* between pairs of sites:

```{r similarity}
similarity(count, method = "morisita")
```


### Seriation

```{r seriate-incidence}
# Build an incidence matrix with random data
incidence <- IncidenceMatrix(data = sample(0:1, 400, TRUE, c(0.6, 0.4)),
                             nrow = 20)

# Get seriation order on rows and columns
# Correspondance analysis-based seriation
(indices <- seriate(incidence, method = "correspondance", margin = c(1, 2)))
```

```{r permute-incidence, eval=FALSE, warning=FALSE}
# Permute matrix rows and columns
incidence2 <- permute(incidence, indices)

# Plot matrix
library(ggplot2)
plotMatrix(incidence) + 
  labs(title = "Original matrix") +
  scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "white"))
plotMatrix(incidence2) + 
  labs(title = "Rearranged matrix") +
  scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "white"))
```

```{r permute-incidence-plots, echo=FALSE, warning=FALSE, fig.height=3.5}
# Permute matrix rows and columns
incidence2 <- permute(incidence, indices)

# Plot matrix
cowplot::plot_grid(
  plotMatrix(incidence) + 
    labs(title = "Original matrix") +
    ggplot2::scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "white")),
  plotMatrix(incidence2) + 
    labs(title = "Rearranged matrix") +
    ggplot2::scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "white")),
  ncol = 2
)
```

### Visualization

`tabula` makes an extensive use of `ggplot2` for plotting informations. This makes it easy to customize diagramms (e.g. using themes and scales).

Bertin of Ford (battleship curve) diagramms can be plotted, with statistic threshold (B. Desachy's sériographe [^1]). The positive difference from the column mean percentage (in french "écart positif au pourcentage moyen", EPPM) represents a deviation from the situation of statistical independence. EPPM is a usefull graphical tool to explore significance of relationship between rows and columns related to seriation.

```{r seriograph, fig.height=3.5}
plotBar(count, EPPM = TRUE)
```


Matrix plot is displayed as a heatmap. The PVI matrix (B. Desachy's matrigraphe) allows to explore deviations from independence (an intuitive graphical approach to $\chi^2$),
```{r matrigraph, fig.height=3.5}
plotMatrix(count, PVI = TRUE) +
  ggplot2::scale_fill_gradient2(midpoint = 1)
```

Spot matrix (no doubt easier to read than a heatmap [^2]) allows direct examination of data (above/below some threshold):
```{r spot, fig.height=3.5}
plotSpot(count, threshold = mean)
```

Ranks *vs* abundance plot can be used for abundance models (model fitting will be implemented in a futur release):
```{r rank, fig.height=3.5}
plotRank(count, log = "xy")
```

[^1]: Desachy, B. (2004). Le sériographe EPPM : un outil informatisé de sériation graphique pour tableaux de comptages. *Revue archéologique de Picardie*, 3(1), 39-56. DOI: [10.3406/pica.2004.2396](https://doi.org/10.3406/pica.2004.2396).

[^2]: Adapted from Dan Gopstein's original [spot matrix](https://dgopstein.github.io/articles/spot-matrix/).
